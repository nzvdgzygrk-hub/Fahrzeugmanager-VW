<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>VW Touran Fahrzeugmanager</title>
  <style>
    :root {
      --vw-blue: #004b87;
      --vw-blue-light: #e3f2fd;
      --vw-grey-bg: #eef2f5;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--vw-grey-bg);
      padding: 20px;
    }

    .box {
      background: #ffffff;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.08);
      margin-bottom: 28px;
      border-top: 4px solid var(--vw-blue);
    }

    h2 {
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--vw-blue);
      font-size: 20px;
    }

    .icon {
      font-size: 22px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #ffffff;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
    }

    th {
      background: #f5f7fa;
      color: #333;
    }

    input, select {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 14px;
    }

    button {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      background: var(--vw-blue);
      color: white;
      cursor: pointer;
      margin-top: 10px;
      font-size: 14px;
    }

    button:hover {
      background: #003764;
    }

    .task-block {
      margin-bottom: 18px;
      padding: 15px;
      background: var(--vw-blue-light);
      border-radius: 10px;
      border: 1px solid #c5d7e8;
    }

    .task-block h3 {
      margin: 0 0 8px 0;
      color: #003764;
      font-size: 16px;
    }

    .task-block small {
      font-weight: normal;
      color: #555;
      font-size: 12px;
    }

    /* mobilefreundlich: alles untereinander */
    .entry-row {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
      margin-bottom: 10px;
    }

    .entry-row .check-wrap {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .entry-row .check-wrap label {
      font-size: 13px;
    }

    .monthbox {
      padding: 10px;
      background: #f5f5f5;
      border-radius: 10px;
      margin-top: 10px;
      border: 1px solid #ddd;
      font-size: 14px;
    }

    ul {
      margin: 0 0 0 18px;
      padding: 0;
    }
  </style>
</head>
<body>

  <!-- DASHBOARD -->
  <div class="box">
    <h2><span class="icon">üìä</span>√úbersicht (Dashboard)</h2>
    <ul>
      <li><b>T√úV:</b> <span id="dashTuev">‚Äì</span></li>
      <li><b>Letzter √ñlwechsel:</b> <span id="dashOil">‚Äì</span></li>
      <li><b>N√§chster √ñlwechsel:</b> <span id="dashNextOil">‚Äì</span></li>
      <li><b>Letzte Reparaturkosten:</b> <span id="dashLastRepair">‚Äì</span></li>
      <li><b>Letzter Verbrauch:</b> <span id="dashFuel">‚Äì</span></li>
    </ul>
  </div>

  <!-- FAHRZEUGDATEN -->
  <div class="box">
    <h2><span class="icon">üöó</span>Fahrzeugdaten ‚Äì Volkswagen Touran</h2>

    <label>Marke</label>
    <input id="marke" value="Volkswagen">

    <label>Modell</label>
    <input id="modell" value="Touran 2.0 TDI 110kW">

    <label>Schl√ºsselnummer 2.1</label>
    <input id="hsn" value="4527">

    <label>Schl√ºsselnummer 2.2</label>
    <input id="tsn" value="4632">

    <label>Kennzeichen</label>
    <input id="plate">

    <label>T√úV g√ºltig bis</label>
    <input type="date" id="tuev">

    <button onclick="saveVehicle()">Fahrzeugdaten speichern</button>
  </div>

  <!-- INSPEKTIONSPLAN (FIX) -->
  <div class="box">
    <h2><span class="icon">üõ†Ô∏è</span>VW Inspektionsplan (Fix)</h2>
    <p>Standardarbeiten mit festen Intervallen. H√§kchen = erledigt, Datum wird automatisch gesetzt und in die Wartungshistorie √ºbernommen.</p>
    <div id="inspectionList"></div>
  </div>

  <!-- MANUELLE WARTUNG -->
  <div class="box">
    <h2><span class="icon">üìã</span>Wartung manuell eintragen</h2>

    <label>Kilometer</label>
    <input id="manKM" type="number">

    <label>Arbeit</label>
    <input id="manTask" type="text" placeholder="z. B. Zahnriemen">

    <label>Kosten (‚Ç¨)</label>
    <input id="manCost" type="number" step="0.01" placeholder="optional">

    <button onclick="addManualWartung()">Wartung speichern</button>
  </div>

  <!-- WARTUNGSHISTORIE -->
  <div class="box">
    <h2><span class="icon">üìö</span>Wartungshistorie</h2>
    <table>
      <thead>
        <tr><th>Datum</th><th>KM</th><th>Arbeit</th><th>Kosten</th></tr>
      </thead>
      <tbody id="wartungHistory"></tbody>
    </table>
    <button onclick="undoLastHistory()">Letzten Eintrag r√ºckg√§ngig (Passwort)</button>
    <br><br>
    <button onclick="exportWartungText()">Export Wartung (WhatsApp)</button>
  </div>

  <!-- MONATSKOSTEN -->
  <div class="box">
    <h2><span class="icon">üìÖ</span>Reparaturkosten pro Monat</h2>
    <div id="repMonth"></div>
  </div>

  <!-- TANKEN -->
  <div class="box">
    <h2><span class="icon">‚õΩ</span>Tanken &amp; Verbrauch</h2>

    <label>Datum</label>
    <input type="date" id="tankDate">

    <label>Kilometer</label>
    <input type="number" id="tankKM">

    <label>Liter</label>
    <input type="number" id="tankL" step="0.01">

    <label>Preis pro Liter (‚Ç¨)</label>
    <input type="number" id="tankP" step="0.001">

    <button onclick="addTank()">Tanken eintragen</button>

    <table>
      <thead>
        <tr><th>Datum</th><th>KM</th><th>Liter</th><th>Preis/L</th><th>Kosten</th><th>Verbrauch (L/100km)</th></tr>
      </thead>
      <tbody id="tankList"></tbody>
    </table>

    <button onclick="exportTankText()">Export Tanken (WhatsApp)</button>
  </div>

  <script>
    // ============================
    // Feste VW-Inspektionsdaten (Variante A)
    // ============================
    const fixedTasks = [
      // √ñlwechsel bei: 30k, 60k, 90k, 120k, 150k, 180k, 210k, 240k, 270k, 300k, 330k
      { id: "oil",   title: "√ñlwechsel",        interval: 30000, preset: [30000, 60000, 90000, 120000, 150000, 180000, 210000, 240000, 270000, 300000, 330000] },
      // Innenraumfilter
      { id: "innen", title: "Innenraumfilter",  interval: 60000, preset: [60000, 120000, 180000, 240000] },
      // Luftfilter
      { id: "luft",  title: "Luftfilter",       interval: 90000, preset: [90000, 180000, 270000] },
      // Kraftstofffilter
      { id: "diesel",title: "Kraftstofffilter", interval: 90000, preset: [90000, 180000, 270000] },
      // Schaltgetriebe√∂l
      { id: "gear",  title: "Schaltgetriebe√∂l", interval: 60000, preset: [60000, 120000, 180000, 240000] },
      // Bremsfl√ºssigkeit (alle 2 Jahre, Startdatum)
      { id: "brake", title: "Bremsfl√ºssigkeit", interval: "alle 2 Jahre", preset: ["11.01.2023"] }
    ];

    // ============================
    // Inspektionsliste rendern
    // ============================
    function renderInspectionList() {
      const box = document.getElementById("inspectionList");
      box.innerHTML = "";

      fixedTasks.forEach(task => {
        const div = document.createElement("div");
        div.className = "task-block";

        const title = document.createElement("h3");
        title.innerHTML = task.title + " <small>(" + task.interval + ")</small>";
        div.appendChild(title);

        task.preset.forEach((presetValue, index) => {
          const id = task.id + "_" + index;

          const row = document.createElement("div");
          row.className = "entry-row";

          // KM Feld (fix, nur Zahl oder Text)
          const kmInput = document.createElement("input");
          kmInput.id = "km_" + id;
          kmInput.disabled = true;
          kmInput.value = presetValue;

          // Datum
          const dateInput = document.createElement("input");
          dateInput.id = "dt_" + id;
          dateInput.placeholder = "Datum";

          // Checkbox + Label
          const checkWrap = document.createElement("div");
          checkWrap.className = "check-wrap";

          const check = document.createElement("input");
          check.type = "checkbox";
          check.id = "chk_" + id;

          const lab = document.createElement("label");
          lab.htmlFor = check.id;
          lab.textContent = "erledigt";

          check.addEventListener("change", function () {
            if (this.checked) {
              finishInspection(task.id, presetValue, id);
            }
          });

          checkWrap.appendChild(check);
          checkWrap.appendChild(lab);

          row.appendChild(kmInput);
          row.appendChild(dateInput);
          row.appendChild(checkWrap);

          div.appendChild(row);
        });

        box.appendChild(div);
      });
    }

    // ============================
    // Inspektion abgeschlossen ‚Üí Historie
    // ============================
    function finishInspection(taskId, kmValue, id) {
      const today = new Date().toISOString().split("T")[0];
      const dateInput = document.getElementById("dt_" + id);
      dateInput.value = today;

      // taskId ist hier nur die Kurz-ID, f√ºr die Historie nehmen wir den Titel
      const taskObj = fixedTasks.find(t => t.id === taskId);
      const taskName = taskObj ? taskObj.title : taskId;

      addHistory(taskName, kmValue, today, 0);
    }

    // ============================
    // Manuelle Wartung
    // ============================
    function addManualWartung() {
      const km = document.getElementById("manKM").value;
      const task = document.getElementById("manTask").value.trim();
      const costStr = document.getElementById("manCost").value;

      if (!km || !task) {
        alert("Bitte Kilometer und Arbeit eintragen!");
        return;
      }

      const today = new Date().toISOString().split("T")[0];
      const cost = costStr ? Number(costStr) : 0;

      addHistory(task, km, today, cost);

      document.getElementById("manKM").value = "";
      document.getElementById("manTask").value = "";
      document.getElementById("manCost").value = "";
    }

    // ============================
    // Wartungshistorie speichern
    // ============================
    function addHistory(task, km, date, cost) {
      const list = JSON.parse(localStorage.getItem("vw_hist") || "[]");
      list.push({ task: task, km: km, date: date, cost: cost });
      localStorage.setItem("vw_hist", JSON.stringify(list));
      renderHistory();
      renderMonthly();
      renderDashboard();
    }

    // ============================
    // Wartungshistorie anzeigen
    // ============================
    function renderHistory() {
      const list = JSON.parse(localStorage.getItem("vw_hist") || "[]");
      list.sort((a, b) => new Date(a.date) - new Date(b.date));

      const tb = document.getElementById("wartungHistory");
      tb.innerHTML = "";

      list.forEach(e => {
        const tr = document.createElement("tr");
        const costText = e.cost ? Number(e.cost).toFixed(2) + " ‚Ç¨" : "";
        tr.innerHTML = "<td>" + e.date + "</td><td>" + e.km + "</td><td>" + e.task + "</td><td>" + costText + "</td>";
        tb.appendChild(tr);
      });
    }

    // ============================
    // Letzten Eintrag r√ºckg√§ngig (Passwort: Fatih)
    // ============================
    function undoLastHistory() {
      const pw = prompt("Passwort zum R√ºckg√§ngig machen:");
      if (pw !== "Fatih") {
        alert("Falsches Passwort.");
        return;
      }

      const list = JSON.parse(localStorage.getItem("vw_hist") || "[]");
      if (list.length === 0) {
        alert("Keine Eintr√§ge vorhanden.");
        return;
      }

      list.pop();
      localStorage.setItem("vw_hist", JSON.stringify(list));
      renderHistory();
      renderMonthly();
      renderDashboard();
    }

    // ============================
    // Monatskosten berechnen
    // ============================
    function renderMonthly() {
      const list = JSON.parse(localStorage.getItem("vw_hist") || "[]");
      const map = {};

      list.forEach(e => {
        if (!e.date) return;
        const key = e.date.slice(0, 7); // YYYY-MM
        const cost = e.cost ? Number(e.cost) : 0;
        map[key] = (map[key] || 0) + cost;
      });

      const box = document.getElementById("repMonth");
      box.innerHTML = "";

      Object.keys(map).sort().forEach(month => {
        const div = document.createElement("div");
        div.className = "monthbox";
        div.innerHTML = "<b>" + month + "</b>: " + map[month].toFixed(2) + " ‚Ç¨";
        box.appendChild(div);
      });
    }

    // ============================
    // Tanken
    // ============================
    function addTank() {
      const d = document.getElementById("tankDate").value;
      const kmStr = document.getElementById("tankKM").value;
      const lStr  = document.getElementById("tankL").value;
      const pStr  = document.getElementById("tankP").value;

      if (!d || !kmStr || !lStr || !pStr) {
        alert("Bitte alle Tankdaten eintragen.");
        return;
      }

      const km    = Number(kmStr);
      const liter = Number(lStr);
      const preis = Number(pStr);

      const cost = liter * preis;
      const verb = km > 0 ? (liter / km) * 100 : 0;

      const list = JSON.parse(localStorage.getItem("vw_tank") || "[]");
      list.push({ d: d, km: km, l: liter, p: preis, cost: cost, verb: verb });
      localStorage.setItem("vw_tank", JSON.stringify(list));

      renderTank();
      renderDashboard();
    }

    function renderTank() {
      const list = JSON.parse(localStorage.getItem("vw_tank") || "[]");
      const tb = document.getElementById("tankList");
      tb.innerHTML = "";

      list.forEach(e => {
        const tr = document.createElement("tr");
        tr.innerHTML =
          "<td>" + e.d + "</td>" +
          "<td>" + e.km + "</td>" +
          "<td>" + e.l.toFixed(2) + "</td>" +
          "<td>" + e.p.toFixed(3) + " ‚Ç¨</td>" +
          "<td>" + e.cost.toFixed(2) + " ‚Ç¨</td>" +
          "<td>" + e.verb.toFixed(2) + "</td>";
        tb.appendChild(tr);
      });
    }

    // ============================
    // WhatsApp-Export (Zwischenablage)
    // ============================
    function exportWartungText() {
      const list = JSON.parse(localStorage.getItem("vw_hist") || "[]");
      let text = "Wartung:\n";

      list.forEach(e => {
        const cost = e.cost ? Number(e.cost).toFixed(2) + " ‚Ç¨" : "";
        text += e.date + " - " + e.km + " km - " + e.task + " - " + cost + "\n";
      });

      navigator.clipboard.writeText(text)
        .then(() => alert("Wartungsdaten kopiert ‚Äì jetzt in WhatsApp einf√ºgen."))
        .catch(() => alert("Konnte nicht in die Zwischenablage kopieren."));
    }

    function exportTankText() {
      const list = JSON.parse(localStorage.getItem("vw_tank") || "[]");
      let text = "Tanken:\n";

      list.forEach(e => {
        text += e.d + " - " + e.km + " km - " + e.l.toFixed(2) +
          " L - " + e.cost.toFixed(2) + " ‚Ç¨\n";
      });

      navigator.clipboard.writeText(text)
        .then(() => alert("Tankdaten kopiert ‚Äì jetzt in WhatsApp einf√ºgen."))
        .catch(() => alert("Konnte nicht in die Zwischenablage kopieren."));
    }

    // ============================
    // Fahrzeugdaten speichern
    // ============================
    function saveVehicle() {
      const data = {
        marke:  document.getElementById("marke").value,
        modell: document.getElementById("modell").value,
        hsn:    document.getElementById("hsn").value,
        tsn:    document.getElementById("tsn").value,
        plate:  document.getElementById("plate").value,
        tuev:   document.getElementById("tuev").value
      };
      localStorage.setItem("vw_vehicle", JSON.stringify(data));
      alert("Fahrzeugdaten gespeichert.");
      renderDashboard();
    }

    // ============================
    // Dashboard
    // ============================
    function renderDashboard() {
      const tuevSpan   = document.getElementById("dashTuev");
      const oilSpan    = document.getElementById("dashOil");
      const nextOilSpan= document.getElementById("dashNextOil");
      const lastRepSpan= document.getElementById("dashLastRepair");
      const fuelSpan   = document.getElementById("dashFuel");

      // T√úV
      const vehicleRaw = localStorage.getItem("vw_vehicle");
      if (vehicleRaw) {
        const v = JSON.parse(vehicleRaw);
        if (v.tuev) {
          const d = new Date(v.tuev);
          const today = new Date();
          d.setHours(0,0,0,0);
          today.setHours(0,0,0,0);
          const diffDays = Math.round((d.getTime() - today.getTime()) / (1000*60*60*24));
          const dateText = d.toLocaleDateString("de-DE");
          if (diffDays > 0) tuevSpan.textContent = "bis " + dateText + " (" + diffDays + " Tage)";
          else if (diffDays === 0) tuevSpan.textContent = "l√§uft heute ab (" + dateText + ")";
          else tuevSpan.textContent = "abgelaufen am " + dateText + " (" + Math.abs(diffDays) + " Tage)";
        } else {
          tuevSpan.textContent = "keine Daten";
        }
      } else {
        tuevSpan.textContent = "keine Daten";
      }

      const hist = JSON.parse(localStorage.getItem("vw_hist") || "[]");

      // Letzter √ñlwechsel
      const oilEntries = hist.filter(e =>
        e.task.toLowerCase().indexOf("√∂l") !== -1 || e.task.toLowerCase().indexOf("oel") !== -1
      );
      if (oilEntries.length > 0) {
        const lastOil = oilEntries[oilEntries.length - 1];
        oilSpan.textContent = lastOil.date + " bei " + lastOil.km + " km";
        const interval = fixedTasks[0].interval || 30000;
        if (!isNaN(interval) && lastOil.km) {
          const nextKm = Number(lastOil.km) + interval;
          nextOilSpan.textContent = "ca. " + nextKm + " km";
        } else {
          nextOilSpan.textContent = "Intervall vorhanden, aber kein km-Wert";
        }
      } else {
        oilSpan.textContent = "keine Eintr√§ge";
        nextOilSpan.textContent = "keine Daten";
      }

      // Letzte Reparaturkosten
      const costEntries = hist.filter(e => e.cost && Number(e.cost) > 0);
      if (costEntries.length > 0) {
        const last = costEntries[costEntries.length - 1];
        lastRepSpan.textContent = last.date + " (" + Number(last.cost).toFixed(2) + " ‚Ç¨)";
      } else {
        lastRepSpan.textContent = "keine Kosten erfasst";
      }

      // Letzter Verbrauch
      const fuelList = JSON.parse(localStorage.getItem("vw_tank") || "[]");
      if (fuelList.length > 0) {
        const lastTank = fuelList[fuelList.length - 1];
        fuelSpan.textContent = lastTank.verb.toFixed(2) + " L/100km";
      } else {
        fuelSpan.textContent = "keine Tankdaten";
      }
    }

    // ============================
    // Initial laden
    // ============================
    renderInspectionList();
    renderHistory();
    renderMonthly();
    renderTank();
    renderDashboard();
  </script>
</body>
</html>
