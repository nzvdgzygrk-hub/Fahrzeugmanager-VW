<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>VW Touran Fahrzeugmanager</title>
  <style>
    :root {
      --vw-blue: #004b87;
      --vw-blue-light: #e3f2fd;
      --vw-grey-bg: #eef2f5;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--vw-grey-bg);
      padding: 20px;
    }

    .box {
      background: #ffffff;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.08);
      margin-bottom: 28px;
      border-top: 4px solid var(--vw-blue);
    }

    h2 {
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--vw-blue);
      font-size: 20px;
    }

    .icon {
      font-size: 22px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #ffffff;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
    }

    th {
      background: #f5f7fa;
      color: #333;
    }

    input, select {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 14px;
    }

    button {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      background: var(--vw-blue);
      color: white;
      cursor: pointer;
      margin-top: 10px;
      font-size: 14px;
    }

    button:hover {
      background: #003764;
    }

    .task-block {
      margin-bottom: 10px;
      padding: 10px;
      background: var(--vw-blue-light);
      border-radius: 10px;
      border: 1px solid #c5d7e8;
    }

    .task-title {
      font-weight: bold;
      color: #003764;
      margin-bottom: 4px;
      font-size: 14px;
    }

    .entry-row {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }

    .entry-row label {
      font-size: 12px;
      color: #333;
    }

    .entry-row .check-wrap {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
    }

    .entry-row .check-wrap label {
      font-size: 13px;
    }

    .monthbox {
      padding: 10px;
      background: #f5f5f5;
      border-radius: 10px;
      margin-top: 10px;
      border: 1px solid #ddd;
      font-size: 14px;
    }

    ul {
      margin: 0 0 0 18px;
      padding: 0;
    }

    .sort-buttons {
      margin-bottom: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .sort-buttons button {
      padding: 6px 10px;
      font-size: 12px;
      margin-top: 0;
    }

    .dash-hint {
      margin-top: 10px;
      text-align: right;
      font-size: 12px;
      color: #555;
      line-height: 1.3;
    }
  </style>
</head>
<body>

  <!-- DASHBOARD -->
  <div class="box">
    <h2><span class="icon">üìä</span>√úbersicht (Dashboard)</h2>
    <ul>
      <li><b>T√úV:</b> <span id="dashTuev">‚Äì</span></li>
      <li><b>Letzter √ñlwechsel:</b> <span id="dashOil">‚Äì</span></li>
      <li><b>N√§chster √ñlwechsel:</b> <span id="dashNextOil">‚Äì</span></li>
      <li><b>N√§chste Wartung(en):</b> <span id="dashNextService">‚Äì</span></li>
      <li><b>Letzte Reparaturkosten:</b> <span id="dashLastRepair">‚Äì</span></li>
      <li><b>Letzter Verbrauch:</b> <span id="dashFuel">‚Äì</span></li>
    </ul>
    <div class="dash-hint">
      √ñl / Filter / Standard<br>
      √ñlwechsel ‚Äì alle 30.000 km (30k / 60k / 90k / 120k ...)<br>
      Innenraumfilter ‚Äì alle 60.000 km<br>
      Luftfilter ‚Äì alle 90.000 km<br>
      Kraftstofffilter (Diesel) ‚Äì alle 90.000 km<br>
      Schaltgetriebe√∂l ‚Äì alle 60.000 km
    </div>
  </div>

  <!-- FAHRZEUGDATEN -->
  <div class="box">
    <h2><span class="icon">üöó</span>Fahrzeugdaten ‚Äì Volkswagen Touran</h2>

    <label>Marke</label>
    <input id="marke">

    <label>Modell</label>
    <input id="modell">

    <label>Schl√ºsselnummer 2.1</label>
    <input id="hsn">

    <label>Schl√ºsselnummer 2.2</label>
    <input id="tsn">

    <label>Kennzeichen</label>
    <input id="plate">

    <label>T√úV g√ºltig bis</label>
    <input type="date" id="tuev">

    <button onclick="saveVehicle()">Fahrzeugdaten speichern</button>
  </div>

  <!-- INSPEKTIONSPLAN (FIX, ALLES UNTEREINANDER) -->
  <div class="box">
    <h2><span class="icon">üõ†Ô∏è</span>Fixe Wartung (VW-Plan)</h2>
    <p>Jede Zeile = eine feste Wartung. Du kannst den tats√§chlichen KM-Stand eintragen, das Dashboard nutzt diesen Wert.</p>
    <div id="inspectionList"></div>
  </div>

  <!-- MANUELLE WARTUNG -->
  <div class="box">
    <h2><span class="icon">üìã</span>Wartung manuell eintragen</h2>

    <label>Kilometer</label>
    <input id="manKM" type="number">

    <label>Arbeit</label>
    <input id="manTask" type="text" placeholder="z. B. T√úV, Zahnriemen">

    <label>Kosten (‚Ç¨)</label>
    <input id="manCost" type="number" step="0.01" placeholder="optional">

    <button onclick="addManualWartung()">Wartung speichern</button>
  </div>

  <!-- WARTUNGSHISTORIE -->
  <div class="box">
    <h2><span class="icon">üìö</span>Wartungshistorie</h2>

    <div class="sort-buttons">
      <span>Sortieren nach:</span>
      <button onclick="setHistorySort('date')">Datum</button>
      <button onclick="setHistorySort('km')">Kilometer</button>
      <button onclick="setHistorySort('task')">Kategorie</button>
    </div>

    <table>
      <thead>
        <tr><th>Datum (leer oder Jahr/Datum)</th><th>KM</th><th>Arbeit</th><th>Kosten</th></tr>
      </thead>
      <tbody id="wartungHistory"></tbody>
    </table>
    <button onclick="undoLastHistory()">Letzten Eintrag r√ºckg√§ngig (Passwort)</button>
    <br><br>
    <button onclick="exportWartungText()">Export Wartung (WhatsApp)</button>
  </div>

  <!-- MONATSKOSTEN WARTUNG -->
  <div class="box">
    <h2><span class="icon">üìÖ</span>Reparaturkosten pro Monat</h2>
    <div id="repMonth"></div>
  </div>

  <!-- TANKEN -->
  <div class="box">
    <h2><span class="icon">‚õΩ</span>Tanken &amp; Verbrauch</h2>

    <label>Gefahrene Kilometer</label>
    <input type="number" id="tankKM">

    <label>Liter</label>
    <input type="number" id="tankL" step="0.01">

    <label>Preis pro Liter (‚Ç¨)</label>
    <input type="number" id="tankP" step="0.001">

    <button onclick="addTank()">√úbernehmen</button>

    <table>
      <thead>
        <tr><th>Datum</th><th>KM</th><th>Liter</th><th>Preis/L</th><th>Kosten</th><th>Verbrauch (L/100km)</th></tr>
      </thead>
      <tbody id="tankList"></tbody>
    </table>

    <button onclick="undoLastTank()">Letzten Tank-Eintrag l√∂schen (Passwort)</button>
    <br><br>
    <button onclick="exportTankText()">Export Tanken (WhatsApp)</button>
  </div>

  <!-- TANK-MONATS√úBERSICHT -->
  <div class="box">
    <h2><span class="icon">üìÖ</span>Tank√ºbersicht pro Monat</h2>
    <div id="tankMonth"></div>
  </div>

  <script>
    // ==== Helfer zum Formatieren von KM (1.000 statt 1000) ====
    function formatKm(value) {
      const n = Number(value);
      if (!isFinite(n)) return value;
      return n.toLocaleString('de-DE');
    }

    // Datum-String in Zahl zum Sortieren umwandeln (unterst√ºtzt Jahr ODER voll)
    function parseDateLike(str) {
      if (!str) return 0;
      str = String(str).trim();
      // nur Jahr, z.B. "2020"
      if (/^\d{4}$/.test(str)) {
        return new Date(str + "-01-01").getTime();
      }
      // sonst normal parsen
      var t = Date.parse(str);
      return isNaN(t) ? 0 : t;
    }

    // ===== Feste VW-Inspektionsdaten =====
    const fixedTasks = [
      { id: "oil",   title: "√ñlwechsel",              interval: 30000,  presets: [30000, 60000, 90000, 120000, 150000, 180000, 210000, 240000, 270000, 300000, 330000] },
      { id: "innen", title: "Innenraumfilter",        interval: 60000,  presets: [60000, 120000, 180000, 240000] },
      { id: "luft",  title: "Luftfilter",             interval: 90000,  presets: [90000, 180000, 270000] },
      { id: "diesel",title: "Kraftstofffilter",       interval: 90000,  presets: [90000, 180000, 270000] },
      { id: "gear",  title: "Schaltgetriebe√∂l",       interval: 60000,  presets: [60000, 120000, 180000, 240000] },
      { id: "brake", title: "Bremsfl√ºssigkeit",       interval: 60000,  presets: [60000, 120000, 180000, 240000] },
      { id: "belt",  title: "Zahnriemen",             interval: 210000, presets: [210000] },
      { id: "tens",  title: "Spannrolle Zahnriemen",  interval: 210000, presets: [210000] },
      { id: "dpf",   title: "Ru√üpartikelfilter (DPF)",interval: 210000, presets: [210000] }
    ];

    const FIXED_STATE_KEY = "vw_fixed"; // Zustand der H√§kchen + kmDone

    // flache Liste aller festen Eintr√§ge, sortiert nach km
    const fixedEntries = [];
    fixedTasks.forEach(function(task) {
      task.presets.forEach(function(preset, idx) {
        if (typeof preset === "number") {
          fixedEntries.push({
            key: task.id + "_" + idx,
            taskId: task.id,
            title: task.title,
            baseKm: preset,
            interval: task.interval
          });
        }
      });
    });
    fixedEntries.sort(function(a, b) { return a.baseKm - b.baseKm; });

    // ===== fixe Wartung Zustand laden/speichern =====
    function getFixedState() {
      return JSON.parse(localStorage.getItem(FIXED_STATE_KEY) || "{}");
    }
    function setFixedState(state) {
      localStorage.setItem(FIXED_STATE_KEY, JSON.stringify(state));
    }
    function updateFixedState(key, newData) {
      var state = getFixedState();
      if (!state[key]) state[key] = {};
      for (var k in newData) {
        state[key][k] = newData[k];
      }
      setFixedState(state);
    }

    // ===== fixe Wartung (Liste) rendern =====
    function renderInspectionList() {
      var box = document.getElementById("inspectionList");
      box.innerHTML = "";

      var fixedState = getFixedState();

      fixedEntries.forEach(function(entry) {
        var div = document.createElement("div");
        div.className = "task-block";

        var title = document.createElement("div");
        title.className = "task-title";
        title.textContent = entry.title;
        div.appendChild(title);

        var row = document.createElement("div");
        row.className = "entry-row";

        // Soll-KM
        var labelSoll = document.createElement("label");
        labelSoll.textContent = "Soll-KM";
        var kmSoll = document.createElement("input");
        kmSoll.disabled = true;
        kmSoll.value = formatKm(entry.baseKm) + " km";

        // Gemacht bei KM
        var labelIst = document.createElement("label");
        labelIst.textContent = "gemacht bei KM";
        var kmDone = document.createElement("input");
        kmDone.id = "done_" + entry.key;
        kmDone.type = "number";
        kmDone.placeholder = "z. B. 31000";

        if (fixedState[entry.key] && fixedState[entry.key].kmDone) {
          kmDone.value = fixedState[entry.key].kmDone;
        }

        kmDone.addEventListener("change", function() {
          var val = this.value ? Number(this.value) : "";
          updateFixedState(entry.key, { kmDone: val });
        });

        // Checkbox
        var checkWrap = document.createElement("div");
        checkWrap.className = "check-wrap";
        var check = document.createElement("input");
        check.type = "checkbox";
        check.id = "chk_" + entry.key;

        if (fixedState[entry.key] && fixedState[entry.key].done) {
          check.checked = true;
        }

        var lab = document.createElement("label");
        lab.htmlFor = check.id;
        lab.textContent = "erledigt";

        check.addEventListener("change", function () {
          if (this.checked) {
            finishFixedEntry(entry);
          } else {
            // nur Zustand zur√ºcksetzen, Historie bleibt
            updateFixedState(entry.key, { done: false });
          }
        });

        checkWrap.appendChild(check);
        checkWrap.appendChild(lab);

        row.appendChild(labelSoll);
        row.appendChild(kmSoll);
        row.appendChild(labelIst);
        row.appendChild(kmDone);
        row.appendChild(checkWrap);

        div.appendChild(row);
        box.appendChild(div);
      });
    }

    // ===== feste Wartung abgeschlossen ‚Üí Historie + Zustand speichern =====
    function finishFixedEntry(entry) {
      var doneField = document.getElementById("done_" + entry.key);
      var kmDone = doneField.value ? Number(doneField.value) : entry.baseKm;
      if (!kmDone || kmDone <= 0) {
        alert("Bitte einen g√ºltigen km-Wert eintragen.");
        var chk = document.getElementById("chk_" + entry.key);
        if (chk) chk.checked = false;
        return;
      }

      var today = new Date().toISOString().split("T")[0];
      addHistory(entry.title, kmDone, today, 0);

      updateFixedState(entry.key, { done: true, kmDone: kmDone });
    }

    // ===== Manuelle Wartung =====
    function addManualWartung() {
      var km = document.getElementById("manKM").value;
      var task = document.getElementById("manTask").value.trim();
      var costStr = document.getElementById("manCost").value;

      if (!km || !task) {
        alert("Bitte Kilometer und Arbeit eintragen!");
        return;
      }

      var today = new Date().toISOString().split("T")[0];
      var cost = costStr ? Number(costStr) : 0;
      var kmNum = Number(km);

      addHistory(task, kmNum, today, cost);

      // Wenn im Text "T√úV" vorkommt ‚Üí T√úV-Datum √ºbernehmen
      if (/t√ºv/i.test(task) || /tuev/i.test(task)) {
        var uebernehmen = confirm("T√úV-Wartung erkannt. Soll das T√úV-Datum √ºbernommen und der n√§chste T√úV (+2 Jahre) berechnet werden?");
        if (uebernehmen) {
          var nextDateObj = new Date(today);
          nextDateObj.setFullYear(nextDateObj.getFullYear() + 2);
          var iso = nextDateObj.toISOString().split("T")[0];

          var tuevInput = document.getElementById("tuev");
          tuevInput.value = iso;

          var existing = localStorage.getItem("vw_vehicle");
          var data = existing ? JSON.parse(existing) : {};
          data.tuev = iso;
          localStorage.setItem("vw_vehicle", JSON.stringify(data));
        }
      }

      document.getElementById("manKM").value = "";
      document.getElementById("manTask").value = "";
      document.getElementById("manCost").value = "";

      renderDashboard();
    }

    // ===== Wartungshistorie speichern =====
    function addHistory(task, km, date, cost) {
      var list = JSON.parse(localStorage.getItem("vw_hist") || "[]");
      list.push({ task: task, km: km, date: date, cost: cost });
      localStorage.setItem("vw_hist", JSON.stringify(list));
      renderHistory();
      renderMonthly();
      renderDashboard();
    }

    var historySortMode = "date"; // "date", "km", "task"

    function setHistorySort(mode) {
      historySortMode = mode;
      renderHistory();
    }

    // ===== Wartungshistorie anzeigen (Datum editierbar TEXT) =====
    function renderHistory() {
      var raw = JSON.parse(localStorage.getItem("vw_hist") || "[]");
      var list = raw.map(function(e, idx) {
        return { task: e.task, km: e.km, date: e.date || "", cost: e.cost, _idx: idx };
      });

      if (historySortMode === "km") {
        list.sort(function(a, b) { return Number(a.km) - Number(b.km); });
      } else if (historySortMode === "task") {
        list.sort(function(a, b) {
          var t = String(a.task).localeCompare(String(b.task));
          if (t !== 0) return t;
          return Number(a.km) - Number(b.km);
        });
      } else {
        list.sort(function(a, b) {
          var ta = parseDateLike(a.date);
          var tb = parseDateLike(b.date);
          return ta - tb;
        });
      }

      var tb = document.getElementById("wartungHistory");
      tb.innerHTML = "";

      list.forEach(function(e) {
        var tr = document.createElement("tr");
        var costText = e.cost ? Number(e.cost).toFixed(2) + " ‚Ç¨" : "";
        tr.innerHTML =
          '<td><input type="text" value="' + (e.date || '') +
          '" placeholder="JJJJ oder JJJJ-MM-TT" onchange="updateHistoryDate(' + e._idx + ', this.value)" /></td>' +
          '<td>' + formatKm(e.km) + '</td>' +
          '<td>' + e.task + '</td>' +
          '<td>' + costText + '</td>';
        tb.appendChild(tr);
      });
    }

    function updateHistoryDate(index, newDate) {
      var list = JSON.parse(localStorage.getItem("vw_hist") || "[]");
      if (!list[index]) return;
      list[index].date = newDate; // kann leer oder nur Jahr sein
      localStorage.setItem("vw_hist", JSON.stringify(list));
      renderHistory();
      renderDashboard();
    }

    // ===== Letzten Eintrag Wartung r√ºckg√§ngig (Passwort Fatih) =====
    function undoLastHistory() {
      var pw = prompt("Passwort zum R√ºckg√§ngig machen:");
      if (pw !== "Fatih") {
        alert("Falsches Passwort.");
        return;
      }

      var list = JSON.parse(localStorage.getItem("vw_hist") || "[]");
      if (list.length === 0) {
        alert("Keine Eintr√§ge vorhanden.");
        return;
      }

      list.pop();
      localStorage.setItem("vw_hist", JSON.stringify(list));
      renderHistory();
      renderMonthly();
      renderDashboard();
    }

    // ===== Monatskosten WARTUNG =====
    function renderMonthly() {
      var list = JSON.parse(localStorage.getItem("vw_hist") || "[]");
      var map = {};

      list.forEach(function(e) {
        if (!e.date) return;
        var key = null;
        if (e.date.length >= 7) {
          key = e.date.slice(0, 7); // YYYY-MM
        } else if (e.date.length >= 4) {
          key = e.date.slice(0, 4); // nur Jahr
        }
        if (!key) return;
        var cost = e.cost ? Number(e.cost) : 0;
        map[key] = (map[key] || 0) + cost;
      });

      var box = document.getElementById("repMonth");
      box.innerHTML = "";

      Object.keys(map).sort().forEach(function(month) {
        var div = document.createElement("div");
        div.className = "monthbox";
        div.innerHTML = "<b>" + month + "</b>: " + map[month].toFixed(2) + " ‚Ç¨";
        box.appendChild(div);
      });
    }

    // ===== Tanken =====
    function addTank() {
      var kmStr = document.getElementById("tankKM").value;
      var lStr  = document.getElementById("tankL").value;
      var pStr  = document.getElementById("tankP").value;

      if (!kmStr || !lStr || !pStr) {
        alert("Bitte Kilometer, Liter und Preis/Liter eintragen.");
        return;
      }

      var d     = new Date().toISOString().split("T")[0]; // aktueller Tag
      var km    = Number(kmStr);
      var liter = Number(lStr);
      var preis = Number(pStr);

      var cost = liter * preis;
      var verb = km > 0 ? (liter / km) * 100 : 0;

      var list = JSON.parse(localStorage.getItem("vw_tank") || "[]");
      list.push({ d: d, km: km, l: liter, p: preis, cost: cost, verb: verb });
      localStorage.setItem("vw_tank", JSON.stringify(list));

      document.getElementById("tankKM").value = "";
      document.getElementById("tankL").value  = "";
      document.getElementById("tankP").value  = "";

      renderTank();
      renderTankMonthly();
      renderDashboard();
    }

    function renderTank() {
      var list = JSON.parse(localStorage.getItem("vw_tank") || "[]");
      var tb = document.getElementById("tankList");
      tb.innerHTML = "";

      list.forEach(function(e) {
        var tr = document.createElement("tr");
        tr.innerHTML =
          "<td>" + e.d + "</td>" +
          "<td>" + formatKm(e.km) + "</td>" +
          "<td>" + e.l.toFixed(2) + "</td>" +
          "<td>" + e.p.toFixed(3) + " ‚Ç¨</td>" +
          "<td>" + e.cost.toFixed(2) + " ‚Ç¨</td>" +
          "<td>" + e.verb.toFixed(2) + "</td>";
        tb.appendChild(tr);
      });
    }

    // ===== Tank-Monats√ºbersicht =====
    function renderTankMonthly() {
      var list = JSON.parse(localStorage.getItem("vw_tank") || "[]");
      var map = {};

      list.forEach(function(e) {
        if (!e.d) return;
        var key = e.d.slice(0, 7); // YYYY-MM
        if (!map[key]) {
          map[key] = { cost: 0, liter: 0, verbSum: 0, count: 0 };
        }
        map[key].cost   += e.cost || 0;
        map[key].liter  += e.l || 0;
        if (e.verb || e.verb === 0) {
          map[key].verbSum += e.verb;
          map[key].count   += 1;
        }
      });

      var box = document.getElementById("tankMonth");
      box.innerHTML = "";

      Object.keys(map).sort().forEach(function(month) {
        var m = map[month];
        var avgVerb = m.count ? (m.verbSum / m.count) : 0;
        var div = document.createElement("div");
        div.className = "monthbox";
        div.innerHTML =
          "<b>" + month + "</b>: " +
          m.liter.toFixed(1) + " L, " +
          m.cost.toFixed(2) + " ‚Ç¨, ‚àÖ " +
          avgVerb.toFixed(2) + " L/100km";
        box.appendChild(div);
      });
    }

    // ===== Letzten Tank-Eintrag l√∂schen (Passwort Fatih) =====
    function undoLastTank() {
      var pw = prompt("Passwort zum L√∂schen:");
      if (pw !== "Fatih") {
        alert("Falsches Passwort.");
        return;
      }

      var list = JSON.parse(localStorage.getItem("vw_tank") || "[]");
      if (list.length === 0) {
        alert("Keine Tankeintr√§ge vorhanden.");
        return;
      }

      list.pop();
      localStorage.setItem("vw_tank", JSON.stringify(list));
      renderTank();
      renderTankMonthly();
      renderDashboard();
    }

    // ===== WhatsApp-Export =====
    function exportWartungText() {
      var list = JSON.parse(localStorage.getItem("vw_hist") || "[]");
      var text = "Wartung:\n";

      list.forEach(function(e) {
        var cost = e.cost ? Number(e.cost).toFixed(2) + " ‚Ç¨" : "";
        var dateText = e.date ? e.date : "";
        text += dateText + " - " + formatKm(e.km) + " km - " + e.task + " - " + cost + "\n";
      });

      navigator.clipboard.writeText(text)
        .then(function() { alert("Wartungsdaten kopiert ‚Äì jetzt in WhatsApp einf√ºgen."); })
        .catch(function() { alert("Konnte nicht in die Zwischenablage kopieren."); });
    }

    function exportTankText() {
      var list = JSON.parse(localStorage.getItem("vw_tank") || "[]");
      var text = "Tanken:\n";

      list.forEach(function(e) {
        text += e.d + " - " + formatKm(e.km) + " km - " +
          e.l.toFixed(2) + " L - " + e.cost.toFixed(2) + " ‚Ç¨\n";
      });

      navigator.clipboard.writeText(text)
        .then(function() { alert("Tankdaten kopiert ‚Äì jetzt in WhatsApp einf√ºgen."); })
        .catch(function() { alert("Konnte nicht in die Zwischenablage kopieren."); });
    }

    // ===== Fahrzeugdaten speichern & laden =====
    function saveVehicle() {
      var data = {
        marke:  document.getElementById("marke").value,
        modell: document.getElementById("modell").value,
        hsn:    document.getElementById("hsn").value,
        tsn:    document.getElementById("tsn").value,
        plate:  document.getElementById("plate").value,
        tuev:   document.getElementById("tuev").value
      };
      localStorage.setItem("vw_vehicle", JSON.stringify(data));
      renderDashboard();
      alert("Fahrzeugdaten gespeichert.");
    }

    function loadVehicle() {
      var existing = localStorage.getItem("vw_vehicle");
      if (existing) {
        var data = JSON.parse(existing);
        document.getElementById("marke").value  = data.marke  || "Volkswagen";
        document.getElementById("modell").value = data.modell || "Touran 2.0 TDI 110kW";
        document.getElementById("hsn").value    = data.hsn    || "4527";
        document.getElementById("tsn").value    = data.tsn    || "4632";
        document.getElementById("plate").value  = data.plate  || "";
        document.getElementById("tuev").value   = data.tuev   || "";
      } else {
        // Defaults
        document.getElementById("marke").value  = "Volkswagen";
        document.getElementById("modell").value = "Touran 2.0 TDI 110kW";
        document.getElementById("hsn").value    = "4527";
        document.getElementById("tsn").value    = "4632";
      }
    }

    // Auto-Speichern bei √Ñnderung Fahrzeugdaten
    function setupVehicleAutosave() {
      ["marke","modell","hsn","tsn","plate","tuev"].forEach(function(id) {
        var el = document.getElementById(id);
        el.addEventListener("change", saveVehicle);
      });
    }

    // ===== Dashboard =====
    function renderDashboard() {
      var tuevSpan        = document.getElementById("dashTuev");
      var oilSpan         = document.getElementById("dashOil");
      var nextOilSpan     = document.getElementById("dashNextOil");
      var nextServiceSpan = document.getElementById("dashNextService");
      var lastRepSpan     = document.getElementById("dashLastRepair");
      var fuelSpan        = document.getElementById("dashFuel");

      // T√úV
      var tuevVal = document.getElementById("tuev").value;
      if (!tuevVal) {
        var vehicleRaw = localStorage.getItem("vw_vehicle");
        if (vehicleRaw) {
          var v = JSON.parse(vehicleRaw);
          if (v.tuev) {
            tuevVal = v.tuev;
            document.getElementById("tuev").value = v.tuev;
          }
        }
      }

      if (tuevVal) {
        var d = new Date(tuevVal);
        var today = new Date();
        d.setHours(0,0,0,0);
        today.setHours(0,0,0,0);
        var diffDays = Math.round((d.getTime() - today.getTime()) / (1000*60*60*24));
        var dateText = d.toLocaleDateString("de-DE");
        if (diffDays > 0) tuevSpan.textContent = "bis " + dateText + " (" + diffDays + " Tage)";
        else if (diffDays === 0) tuevSpan.textContent = "l√§uft heute ab (" + dateText + ")";
        else tuevSpan.textContent = "abgelaufen am " + dateText + " (" + Math.abs(diffDays) + " Tage)";
      } else {
        tuevSpan.textContent = "keine Daten";
      }

      var hist = JSON.parse(localStorage.getItem("vw_hist") || "[]");

      // Letzter √ñlwechsel
      var oilEntries = hist.filter(function(e) {
        var t = String(e.task).toLowerCase();
        return t.indexOf("√∂lwechsel") !== -1 || t.indexOf("oelwechsel") !== -1 || t.indexOf("√∂l") !== -1;
      });
      if (oilEntries.length > 0) {
        var lastOil = oilEntries[oilEntries.length - 1];
        oilSpan.textContent =
          (lastOil.date || "") + " bei " + formatKm(lastOil.km) + " km";
        var oilTask = fixedTasks.find(function(t){ return t.id === "oil"; });
        var interval = (oilTask && typeof oilTask.interval === "number") ? oilTask.interval : 30000;
        if (!isNaN(interval) && lastOil.km) {
          var nextKm = Number(lastOil.km) + interval;
          nextOilSpan.textContent = "ca. " + formatKm(nextKm) + " km";
        } else {
          nextOilSpan.textContent = "Intervall vorhanden, aber kein km-Wert";
        }
      } else {
        oilSpan.textContent = "keine Eintr√§ge";
        nextOilSpan.textContent = "keine Daten";
      }

      // N√§chste Wartungen (Top 3)
      var upcoming = [];
      fixedTasks.forEach(function(task) {
        if (typeof task.interval !== "number") return; // nur km-basierte Aufgaben
        var tEntries = hist.filter(function(e){ return e.task === task.title; });
        var nextKm = null;

        if (tEntries.length > 0) {
          var last = tEntries[tEntries.length - 1];
          var lastKm = Number(last.km);
          if (!isFinite(lastKm)) return;
          nextKm = lastKm + task.interval;
        } else {
          var firstPreset = task.presets.find(function(v){ return typeof v === "number"; });
          if (typeof firstPreset !== "number") return;
          nextKm = firstPreset;
        }
        upcoming.push({ task: task.title, km: nextKm });
      });
      upcoming.sort(function(a, b){ return a.km - b.km; });
      if (upcoming.length > 0) {
        var top3 = upcoming.slice(0, 3);
        var text = top3
          .map(function(e){ return e.task + " bei ca. " + formatKm(e.km) + " km"; })
          .join(" | ");
        nextServiceSpan.textContent = text;
      } else {
        nextServiceSpan.textContent = "keine Daten";
      }

      // Letzte Reparaturkosten
      var costEntries = hist.filter(function(e){ return e.cost && Number(e.cost) > 0; });
      if (costEntries.length > 0) {
        var last = costEntries[costEntries.length - 1];
        lastRepSpan.textContent =
          (last.date || "") + " (" + Number(last.cost).toFixed(2) + " ‚Ç¨)";
      } else {
        lastRepSpan.textContent = "keine Kosten erfasst";
      }

      // Letzter Verbrauch
      var fuelList = JSON.parse(localStorage.getItem("vw_tank") || "[]");
      if (fuelList.length > 0) {
        var lastTank = fuelList[fuelList.length - 1];
        fuelSpan.textContent = lastTank.verb.toFixed(2) + " L/100km";
      } else {
        fuelSpan.textContent = "keine Tankdaten";
      }
    }

    // ===== Initial laden =====
    loadVehicle();
    setupVehicleAutosave();
    renderInspectionList();
    renderHistory();
    renderMonthly();
    renderTank();
    renderTankMonthly();
    renderDashboard();
  </script>
</body>
</html>
