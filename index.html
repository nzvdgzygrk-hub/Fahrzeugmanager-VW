<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>VW Touran Fahrzeugmanager</title>
  <style>
    :root {
      --vw-blue: #004b87;
      --vw-blue-light: #e3f2fd;
      --vw-grey-bg: #eef2f5;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--vw-grey-bg);
      padding: 20px;
    }

    .box {
      background: #ffffff;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.08);
      margin-bottom: 28px;
      border-top: 4px solid var(--vw-blue);
    }

    h2 {
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--vw-blue);
      font-size: 20px;
    }

    .icon {
      font-size: 22px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #ffffff;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
    }

    th {
      background: #f5f7fa;
      color: #333;
    }

    input, select {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 14px;
    }

    button {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      background: var(--vw-blue);
      color: white;
      cursor: pointer;
      margin-top: 10px;
      font-size: 14px;
    }

    button:hover {
      background: #003764;
    }

    .task-block {
      margin-bottom: 10px;
      padding: 10px;
      background: var(--vw-blue-light);
      border-radius: 10px;
      border: 1px solid #c5d7e8;
    }

    .task-title {
      font-weight: bold;
      color: #003764;
      margin-bottom: 4px;
      font-size: 14px;
    }

    .entry-row {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }

    .entry-row label {
      font-size: 12px;
      color: #333;
    }

    .entry-row .check-wrap {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
    }

    .entry-row .check-wrap label {
      font-size: 13px;
    }

    .monthbox {
      padding: 10px;
      background: #f5f5f5;
      border-radius: 10px;
      margin-top: 10px;
      border: 1px solid #ddd;
      font-size: 14px;
    }

    ul {
      margin: 0 0 0 18px;
      padding: 0;
    }

    .sort-buttons {
      margin-bottom: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .sort-buttons button {
      padding: 6px 10px;
      font-size: 12px;
      margin-top: 0;
    }
  </style>
</head>
<body>

  <!-- DASHBOARD -->
  <div class="box">
    <h2><span class="icon">üìä</span>√úbersicht (Dashboard)</h2>
    <ul>
      <li><b>T√úV:</b> <span id="dashTuev">‚Äì</span></li>
      <li><b>Letzter √ñlwechsel:</b> <span id="dashOil">‚Äì</span></li>
      <li><b>N√§chster √ñlwechsel:</b> <span id="dashNextOil">‚Äì</span></li>
      <li><b>N√§chste Wartung(en):</b> <span id="dashNextService">‚Äì</span></li>
      <li><b>Letzte Reparaturkosten:</b> <span id="dashLastRepair">‚Äì</span></li>
      <li><b>Letzter Verbrauch:</b> <span id="dashFuel">‚Äì</span></li>
    </ul>
  </div>

  <!-- FAHRZEUGDATEN -->
  <div class="box">
    <h2><span class="icon">üöó</span>Fahrzeugdaten ‚Äì Volkswagen Touran</h2>

    <label>Marke</label>
    <input id="marke" value="Volkswagen">

    <label>Modell</label>
    <input id="modell" value="Touran 2.0 TDI 110kW">

    <label>Schl√ºsselnummer 2.1</label>
    <input id="hsn" value="4527">

    <label>Schl√ºsselnummer 2.2</label>
    <input id="tsn" value="4632">

    <label>Kennzeichen</label>
    <input id="plate">

    <label>T√úV g√ºltig bis</label>
    <input type="date" id="tuev">

    <button onclick="saveVehicle()">Fahrzeugdaten speichern</button>
  </div>

  <!-- INSPEKTIONSPLAN (FIX, ALLES UNTEREINANDER) -->
  <div class="box">
    <h2><span class="icon">üõ†Ô∏è</span>Fixe Wartung (VW-Plan)</h2>
    <p>Jede Zeile = eine feste Wartung. Du kannst den tats√§chlichen KM-Stand eintragen, das Dashboard nutzt diesen Wert.</p>
    <div id="inspectionList"></div>
  </div>

  <!-- MANUELLE WARTUNG -->
  <div class="box">
    <h2><span class="icon">üìã</span>Wartung manuell eintragen</h2>

    <label>Kilometer</label>
    <input id="manKM" type="number">

    <label>Arbeit</label>
    <input id="manTask" type="text" placeholder="z. B. T√úV, Zahnriemen">

    <label>Kosten (‚Ç¨)</label>
    <input id="manCost" type="number" step="0.01" placeholder="optional">

    <button onclick="addManualWartung()">Wartung speichern</button>
  </div>

  <!-- WARTUNGSHISTORIE -->
  <div class="box">
    <h2><span class="icon">üìö</span>Wartungshistorie</h2>

    <div class="sort-buttons">
      <span>Sortieren nach:</span>
      <button onclick="setHistorySort('date')">Datum</button>
      <button onclick="setHistorySort('km')">Kilometer</button>
      <button onclick="setHistorySort('task')">Kategorie</button>
    </div>

    <table>
      <thead>
        <tr><th>Datum</th><th>KM</th><th>Arbeit</th><th>Kosten</th></tr>
      </thead>
      <tbody id="wartungHistory"></tbody>
    </table>
    <button onclick="undoLastHistory()">Letzten Eintrag r√ºckg√§ngig (Passwort)</button>
    <br><br>
    <button onclick="exportWartungText()">Export Wartung (WhatsApp)</button>
  </div>

  <!-- MONATSKOSTEN -->
  <div class="box">
    <h2><span class="icon">üìÖ</span>Reparaturkosten pro Monat</h2>
    <div id="repMonth"></div>
  </div>

  <!-- TANKEN -->
  <div class="box">
    <h2><span class="icon">‚õΩ</span>Tanken &amp; Verbrauch</h2>

    <label>Datum</label>
    <input type="date" id="tankDate">

    <label>Kilometer</label>
    <input type="number" id="tankKM">

    <label>Liter</label>
    <input type="number" id="tankL" step="0.01">

    <label>Preis pro Liter (‚Ç¨)</label>
    <input type="number" id="tankP" step="0.001">

    <button onclick="addTank()">Tanken eintragen</button>

    <table>
      <thead>
        <tr><th>Datum</th><th>KM</th><th>Liter</th><th>Preis/L</th><th>Kosten</th><th>Verbrauch (L/100km)</th></tr>
      </thead>
      <tbody id="tankList"></tbody>
    </table>

    <button onclick="exportTankText()">Export Tanken (WhatsApp)</button>
  </div>

  <script>
    // ==== Helfer zum Formatieren von KM (1.000 statt 1000) ====
    function formatKm(value) {
      const n = Number(value);
      if (!isFinite(n)) return value;
      return n.toLocaleString('de-DE');
    }

    // ===== Feste VW-Inspektionsdaten =====
    const fixedTasks = [
      { id: "oil",   title: "√ñlwechsel",          interval: 30000, presets: [30000, 60000, 90000, 120000, 150000, 180000, 210000, 240000, 270000, 300000, 330000] },
      { id: "innen", title: "Innenraumfilter",    interval: 60000, presets: [60000, 120000, 180000, 240000] },
      { id: "luft",  title: "Luftfilter",         interval: 90000, presets: [90000, 180000, 270000] },
      { id: "diesel",title: "Kraftstofffilter",   interval: 90000, presets: [90000, 180000, 270000] },
      { id: "gear",  title: "Schaltgetriebe√∂l",   interval: 60000, presets: [60000, 120000, 180000, 240000] },
      { id: "brake", title: "Bremsfl√ºssigkeit",   interval: "alle 2 Jahre", presets: ["11.01.2023"] },
      { id: "belt",  title: "Zahnriemen",         interval: 210000, presets: [210000] },
      { id: "dpf",   title: "Ru√üpartikelfilter",  interval: 180000, presets: [180000] }
    ];

    // Wir bauen eine flache Liste aller festen Eintr√§ge, sortiert nach km
    const fixedEntries = [];
    fixedTasks.forEach(task => {
      task.presets.forEach((preset, idx) => {
        if (typeof preset === "number") {
          fixedEntries.push({
            key: task.id + "_" + idx,
            taskId: task.id,
            title: task.title,
            baseKm: preset,
            interval: task.interval
          });
        }
      });
    });
    fixedEntries.sort((a, b) => a.baseKm - b.baseKm);

    // ===== fixe Wartung (Liste) rendern =====
    function renderInspectionList() {
      const box = document.getElementById("inspectionList");
      box.innerHTML = "";

      fixedEntries.forEach(entry => {
        const div = document.createElement("div");
        div.className = "task-block";

        const title = document.createElement("div");
        title.className = "task-title";
        title.textContent = entry.title;
        div.appendChild(title);

        const row = document.createElement("div");
        row.className = "entry-row";

        // Soll-KM
        const labelSoll = document.createElement("label");
        labelSoll.textContent = "Soll-KM";
        const kmSoll = document.createElement("input");
        kmSoll.disabled = true;
        kmSoll.value = formatKm(entry.baseKm) + " km";

        // Gemacht bei KM
        const labelIst = document.createElement("label");
        labelIst.textContent = "gemacht bei KM";
        const kmDone = document.createElement("input");
        kmDone.id = "done_" + entry.key;
        kmDone.type = "number";
        kmDone.placeholder = "z. B. 31000";

        // Checkbox
        const checkWrap = document.createElement("div");
        checkWrap.className = "check-wrap";
        const check = document.createElement("input");
        check.type = "checkbox";
        check.id = "chk_" + entry.key;
        const lab = document.createElement("label");
        lab.htmlFor = check.id;
        lab.textContent = "erledigt";

        check.addEventListener("change", function () {
          if (this.checked) {
            finishFixedEntry(entry);
          }
        });

        checkWrap.appendChild(check);
        checkWrap.appendChild(lab);

        row.appendChild(labelSoll);
        row.appendChild(kmSoll);
        row.appendChild(labelIst);
        row.appendChild(kmDone);
        row.appendChild(checkWrap);

        div.appendChild(row);
        box.appendChild(div);
      });
    }

    // ===== feste Wartung abgeschlossen ‚Üí Historie =====
    function finishFixedEntry(entry) {
      const doneField = document.getElementById("done_" + entry.key);
      let kmDone = doneField.value ? Number(doneField.value) : entry.baseKm;
      if (!kmDone || kmDone <= 0) {
        alert("Bitte einen g√ºltigen km-Wert eintragen.");
        const chk = document.getElementById("chk_" + entry.key);
        if (chk) chk.checked = false;
        return;
      }

      const today = new Date().toISOString().split("T")[0];
      addHistory(entry.title, kmDone, today, 0);
    }

    // ===== Manuelle Wartung =====
    function addManualWartung() {
      const km = document.getElementById("manKM").value;
      const task = document.getElementById("manTask").value.trim();
      const costStr = document.getElementById("manCost").value;

      if (!km || !task) {
        alert("Bitte Kilometer und Arbeit eintragen!");
        return;
      }

      const today = new Date().toISOString().split("T")[0];
      const cost = costStr ? Number(costStr) : 0;
      const kmNum = Number(km);

      addHistory(task, kmNum, today, cost);

      // Wenn im Text "T√úV" vorkommt ‚Üí T√úV-Datum √ºbernehmen
      if (/t√ºv/i.test(task) || /tuev/i.test(task)) {
        const uebernehmen = confirm("T√úV-Wartung erkannt. Soll das T√úV-Datum √ºbernommen und der n√§chste T√úV (+2 Jahre) berechnet werden?");
        if (uebernehmen) {
          const nextDateObj = new Date(today);
          nextDateObj.setFullYear(nextDateObj.getFullYear() + 2);
          const iso = nextDateObj.toISOString().split("T")[0];

          const tuevInput = document.getElementById("tuev");
          tuevInput.value = iso;

          const existing = localStorage.getItem("vw_vehicle");
          let data = existing ? JSON.parse(existing) : {};
          data.tuev = iso;
          localStorage.setItem("vw_vehicle", JSON.stringify(data));
        }
      }

      document.getElementById("manKM").value = "";
      document.getElementById("manTask").value = "";
      document.getElementById("manCost").value = "";

      renderDashboard();
    }

    // ===== Wartungshistorie speichern =====
    function addHistory(task, km, date, cost) {
      const list = JSON.parse(localStorage.getItem("vw_hist") || "[]");
      list.push({ task, km, date, cost });
      localStorage.setItem("vw_hist", JSON.stringify(list));
      renderHistory();
      renderMonthly();
      renderDashboard();
    }

    let historySortMode = "date"; // "date", "km", "task"

    function setHistorySort(mode) {
      historySortMode = mode;
      renderHistory();
    }

    // ===== Wartungshistorie anzeigen =====
    function renderHistory() {
      let list = JSON.parse(localStorage.getItem("vw_hist") || "[]");

      if (historySortMode === "km") {
        list.sort((a, b) => Number(a.km) - Number(b.km));
      } else if (historySortMode === "task") {
        list.sort((a, b) => {
          const t = a.task.localeCompare(b.task);
          if (t !== 0) return t;
          return Number(a.km) - Number(b.km);
        });
      } else {
        list.sort((a, b) => new Date(a.date) - new Date(b.date));
      }

      const tb = document.getElementById("wartungHistory");
      tb.innerHTML = "";

      list.forEach(e => {
        const tr = document.createElement("tr");
        const costText = e.cost ? Number(e.cost).toFixed(2) + " ‚Ç¨" : "";
        tr.innerHTML =
          "<td>" + e.date + "</td>" +
          "<td>" + formatKm(e.km) + "</td>" +
          "<td>" + e.task + "</td>" +
          "<td>" + costText + "</td>";
        tb.appendChild(tr);
      });
    }

    // ===== Letzten Eintrag r√ºckg√§ngig (Passwort Fatih) =====
    function undoLastHistory() {
      const pw = prompt("Passwort zum R√ºckg√§ngig machen:");
      if (pw !== "Fatih") {
        alert("Falsches Passwort.");
        return;
      }

      const list = JSON.parse(localStorage.getItem("vw_hist") || "[]");
      if (list.length === 0) {
        alert("Keine Eintr√§ge vorhanden.");
        return;
      }

      list.pop();
      localStorage.setItem("vw_hist", JSON.stringify(list));
      renderHistory();
      renderMonthly();
      renderDashboard();
    }

    // ===== Monatskosten =====
    function renderMonthly() {
      const list = JSON.parse(localStorage.getItem("vw_hist") || "[]");
      const map = {};

      list.forEach(e => {
        if (!e.date) return;
        const key = e.date.slice(0, 7); // YYYY-MM
        const cost = e.cost ? Number(e.cost) : 0;
        map[key] = (map[key] || 0) + cost;
      });

      const box = document.getElementById("repMonth");
      box.innerHTML = "";

      Object.keys(map).sort().forEach(month => {
        const div = document.createElement("div");
        div.className = "monthbox";
        div.innerHTML = "<b>" + month + "</b>: " + map[month].toFixed(2) + " ‚Ç¨";
        box.appendChild(div);
      });
    }

    // ===== Tanken =====
    function addTank() {
      const d = document.getElementById("tankDate").value;
      const kmStr = document.getElementById("tankKM").value;
      const lStr  = document.getElementById("tankL").value;
      const pStr  = document.getElementById("tankP").value;

      if (!d || !kmStr || !lStr || !pStr) {
        alert("Bitte alle Tankdaten eintragen.");
        return;
      }

      const km    = Number(kmStr);
      const liter = Number(lStr);
      const preis = Number(pStr);

      const cost = liter * preis;
      const verb = km > 0 ? (liter / km) * 100 : 0;

      const list = JSON.parse(localStorage.getItem("vw_tank") || "[]");
      list.push({ d, km, l: liter, p: preis, cost, verb });
      localStorage.setItem("vw_tank", JSON.stringify(list));

      renderTank();
      renderDashboard();
    }

    function renderTank() {
      const list = JSON.parse(localStorage.getItem("vw_tank") || "[]");
      const tb = document.getElementById("tankList");
      tb.innerHTML = "";

      list.forEach(e => {
        const tr = document.createElement("tr");
        tr.innerHTML =
          "<td>" + e.d + "</td>" +
          "<td>" + formatKm(e.km) + "</td>" +
          "<td>" + e.l.toFixed(2) + "</td>" +
          "<td>" + e.p.toFixed(3) + " ‚Ç¨</td>" +
          "<td>" + e.cost.toFixed(2) + " ‚Ç¨</td>" +
          "<td>" + e.verb.toFixed(2) + "</td>";
        tb.appendChild(tr);
      });
    }

    // ===== WhatsApp-Export =====
    function exportWartungText() {
      const list = JSON.parse(localStorage.getItem("vw_hist") || "[]");
      let text = "Wartung:\n";

      list.forEach(e => {
        const cost = e.cost ? Number(e.cost).toFixed(2) + " ‚Ç¨" : "";
        text += e.date + " - " + formatKm(e.km) + " km - " + e.task + " - " + cost + "\n";
      });

      navigator.clipboard.writeText(text)
        .then(() => alert("Wartungsdaten kopiert ‚Äì jetzt in WhatsApp einf√ºgen."))
        .catch(() => alert("Konnte nicht in die Zwischenablage kopieren."));
    }

    function exportTankText() {
      const list = JSON.parse(localStorage.getItem("vw_tank") || "[]");
      let text = "Tanken:\n";

      list.forEach(e => {
        text += e.d + " - " + formatKm(e.km) + " km - " +
          e.l.toFixed(2) + " L - " + e.cost.toFixed(2) + " ‚Ç¨\n";
      });

      navigator.clipboard.writeText(text)
        .then(() => alert("Tankdaten kopiert ‚Äì jetzt in WhatsApp einf√ºgen."))
        .catch(() => alert("Konnte nicht in die Zwischenablage kopieren."));
    }

    // ===== Fahrzeugdaten speichern =====
    function saveVehicle() {
      const data = {
        marke:  document.getElementById("marke").value,
        modell: document.getElementById("modell").value,
        hsn:    document.getElementById("hsn").value,
        tsn:    document.getElementById("tsn").value,
        plate:  document.getElementById("plate").value,
        tuev:   document.getElementById("tuev").value
      };
      localStorage.setItem("vw_vehicle", JSON.stringify(data));
      alert("Fahrzeugdaten gespeichert.");
      renderDashboard();
    }

    // ===== Dashboard =====
    function renderDashboard() {
      const tuevSpan        = document.getElementById("dashTuev");
      const oilSpan         = document.getElementById("dashOil");
      const nextOilSpan     = document.getElementById("dashNextOil");
      const nextServiceSpan = document.getElementById("dashNextService");
      const lastRepSpan     = document.getElementById("dashLastRepair");
      const fuelSpan        = document.getElementById("dashFuel");

      // T√úV: zuerst direkt aus Input lesen, sonst aus localStorage
      let tuevVal = document.getElementById("tuev").value;
      const vehicleRaw = localStorage.getItem("vw_vehicle");
      if (!tuevVal && vehicleRaw) {
        const v = JSON.parse(vehicleRaw);
        if (v.tuev) {
          tuevVal = v.tuev;
          document.getElementById("tuev").value = v.tuev;
        }
      }

      if (tuevVal) {
        const d = new Date(tuevVal);
        const today = new Date();
        d.setHours(0,0,0,0);
        today.setHours(0,0,0,0);
        const diffDays = Math.round((d.getTime() - today.getTime()) / (1000*60*60*24));
        const dateText = d.toLocaleDateString("de-DE");
        if (diffDays > 0) tuevSpan.textContent = "bis " + dateText + " (" + diffDays + " Tage)";
        else if (diffDays === 0) tuevSpan.textContent = "l√§uft heute ab (" + dateText + ")";
        else tuevSpan.textContent = "abgelaufen am " + dateText + " (" + Math.abs(diffDays) + " Tage)";
      } else {
        tuevSpan.textContent = "keine Daten";
      }

      const hist = JSON.parse(localStorage.getItem("vw_hist") || "[]");

      // Letzter √ñlwechsel
      const oilEntries = hist.filter(e =>
        e.task.toLowerCase().indexOf("√∂lwechsel") !== -1 ||
        e.task.toLowerCase().indexOf("oelwechsel") !== -1 ||
        e.task.toLowerCase().indexOf("√∂l") !== -1
      );
      let lastOil = null;
      if (oilEntries.length > 0) {
        lastOil = oilEntries[oilEntries.length - 1];
        oilSpan.textContent =
          lastOil.date + " bei " + formatKm(lastOil.km) + " km";
        const oilTask = fixedTasks.find(t => t.id === "oil");
        const interval = (oilTask && typeof oilTask.interval === "number") ? oilTask.interval : 30000;
        if (!isNaN(interval) && lastOil.km) {
          const nextKm = Number(lastOil.km) + interval;
          nextOilSpan.textContent = "ca. " + formatKm(nextKm) + " km";
        } else {
          nextOilSpan.textContent = "Intervall vorhanden, aber kein km-Wert";
        }
      } else {
        oilSpan.textContent = "keine Eintr√§ge";
        nextOilSpan.textContent = "keine Daten";
      }

      // N√§chste Wartungen (Top 3)
      const upcoming = [];
      fixedTasks.forEach(task => {
        if (typeof task.interval !== "number") return; // nur km-basierte Aufgaben
        const tEntries = hist.filter(e => e.task === task.title);
        let nextKm = null;

        if (tEntries.length > 0) {
          const last = tEntries[tEntries.length - 1];
          const lastKm = Number(last.km);
          if (!isFinite(lastKm)) return;
          nextKm = lastKm + task.interval;
        } else {
          const firstPreset = task.presets.find(v => typeof v === "number");
          if (typeof firstPreset !== "number") return;
          nextKm = firstPreset;
        }
        upcoming.push({ task: task.title, km: nextKm });
      });
      upcoming.sort((a, b) => a.km - b.km);
      if (upcoming.length > 0) {
        const top3 = upcoming.slice(0, 3);
        const text = top3
          .map(e => e.task + " bei ca. " + formatKm(e.km) + " km")
          .join(" | ");
        nextServiceSpan.textContent = text;
      } else {
        nextServiceSpan.textContent = "keine Daten";
      }

      // Letzte Reparaturkosten
      const costEntries = hist.filter(e => e.cost && Number(e.cost) > 0);
      if (costEntries.length > 0) {
        const last = costEntries[costEntries.length - 1];
        lastRepSpan.textContent =
          last.date + " (" + Number(last.cost).toFixed(2) + " ‚Ç¨)";
      } else {
        lastRepSpan.textContent = "keine Kosten erfasst";
      }

      // Letzter Verbrauch
      const fuelList = JSON.parse(localStorage.getItem("vw_tank") || "[]");
      if (fuelList.length > 0) {
        const lastTank = fuelList[fuelList.length - 1];
        fuelSpan.textContent = lastTank.verb.toFixed(2) + " L/100km";
      } else {
        fuelSpan.textContent = "keine Tankdaten";
      }
    }

    // ===== Initial laden =====
    renderInspectionList();
    renderHistory();
    renderMonthly();
    renderTank();
    renderDashboard();
  </script>
</body>
</html>
